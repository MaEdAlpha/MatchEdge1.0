<table class="mat-elevation-z8" mat-table
      matSort (matSortChange)="sortData($event)"
      [dataSource]="dataSource"
      multiTemplateDataRows>
  <ng-container matColumnDef="{{column.field}}" *ngFor="let column of activeHeaderAliases">
    <form [formGroup]="PandLform">
      <th mat-header-cell mat-sort-header *matHeaderCellDef> {{column.alias}} </th>



    <td mat-cell
      class="mat-column{{flickerColmnIndex}}-data mat-cell-withdata"
      *matCellDef="let sab; let i = dataIndex"
      (click)="loadGroup(i); showSelectionValues(sab, i);">

      <div *ngIf="column.field.endsWith('created') || column.field.endsWith('matchDetail')">
        {{sab[column.field] | date: 'EEE dd LLL HH:mm'}}
      </div>

      <div *ngIf="column.field.endsWith('isSettled')">
        <mat-form-field>
          <mat-label > <span class="pl-label"> Profit/Loss </span></mat-label>
        <input
          matInput
          formControlName="ProfitLoss"
          placeholder="Profit/Loss">
        </mat-form-field>
      <button class="status-btn" mat-raised-button  (click)="sab[column.field]=!sab[column.field]; savePL(sab,i); $event.stopPropagation()" [ngClass]="sab['isSettled'] ? 'settled-overlay' : 'btn-default'"> <span> {{sab[column.field] ? 'Settled' : 'Unsettled'}}</span>  </button>
      </div>

      <!-- <div *ngIf="column.endsWith('betState')">
      <button class="status-button" mat-raised-button (click)="sab[column] = !sab[column]; $event.stopPropagation()">
          <span> {{ sab[column] ? 'Matched' : 'Unmatched'}} </span> </button>
      </div> -->

      <div *ngIf="column.field.endsWith('delete')">
        <ng-container *ngIf="!sab.isSettled">
        <mat-drawer-container class="delete-container" autosize disableClose="false">
          <mat-drawer #drawer class="delete-sidenav" mode="side" position="end" >
            <div class="confirm-delete">
              <button class="confirm-delete"  mat-raised-button (click)="deleteSAB(sab); drawer.toggle();"><mat-icon class="confirm-delete">delete_outline</mat-icon> </button>
            </div>
          </mat-drawer>

          <button class="status-button" mat-raised-button (click)="drawer.toggle(); $event.stopPropagation()">
            <mat-icon>clear</mat-icon></button>
          </mat-drawer-container>
        </ng-container>
        </div>
      <div *ngIf="column.field.endsWith('fixture') || column.field.endsWith('selection')  || column.field.endsWith('backOdd') || column.field.endsWith('stake') || column.field.endsWith('layOdd') || column.field.endsWith('layStake') || column.field.endsWith('ql') || column.field.endsWith('pl') || column.field.endsWith('occ') ">
        {{sab[column.field]}}
      </div>
    </td>
  </form>
  </ng-container>



  <!-- Expanded Content Column - The detail row is made up of this one column that spans across all columns -->
  <ng-container matColumnDef="expandedDetail">
    <td mat-cell *matCellDef="let sab; let i =dataIndex" [attr.colspan]="columnsToDisplay.length">
      <div class="juicyMatch-detail"
           [@detailExpand]="sab == expandedElement ? 'expanded' : 'collapsed'">
      <ng-container *ngIf="expandedElement === sab">
        <form class="form-container"  [formGroup]="selectionValues">

        <div class="expanded-content"  [ngClass]="sab['isSettled'] ? 'settled-overlay' : 'jm-exp-details'"> <!--Expansion container for juicy match-->


          <div class="jm-expanded-container"> <!-- Relevant match values -->

            <div class="teamname shadow">
              <div class="teamnamecontainer">
                <div class="teamname-container">
                  <div class="selection">
                    <p>{{sab.selection}}</p>
                </div>
                  <div class="logo-img-cont">
                  <img src="/assets/img/fcLogo/{{sab.logo}}.png">
                </div>
                <div class="leaguename">
                  <p>League Here</p>
              </div>
                </div>

              </div>
            </div>


            <div class="bookie shadow">
              <div class="bookiecontainer">

                <div class="bookie-container">
                    <p class="bookie-text-lhs">Back Bet</p>
                      <button tabindex="-1" class="bookie-button-container shadow" mat-raised-button href='' ></button>
                </div>

                <div class="bookie-container">
                  <div class="bookie-row">
                    <p class="bookie-text-rhs">Stake</p>
                    <input formControlName="Stake" type="number"step="10" class = "value-box-back"  placeholder="{{sab.stake}}">
                  </div>

                  <div class="bookie-row">
                    <p class= "bookie-text-rhs">Odds </p>
                    <input tabindex="0" formControlName="BackOdds" type="number"step="0.1" class="value-box-back"  placeholder="{{sab.backOdd | number:'0.2-2'}}">
                  </div>
                </div>
              </div>
            </div>

            <div class="exchange shadow">
              <div class="exchangecontainer">
                <div class="exchange-container" >
                  <p class="exchange-text-lhs">Lay Bet </p>
                  <button tabindex="-1" class="exchange-button-container mat-raised-button-bookie-exchange shadow" mat-raised-button href=""></button>
                  <p class="exchange-text-comm">Commission: {{userCommission | number:'0.2-2' }}%</p>
                </div>

                <div class="exchange-container" >
                  <div class="exchange-row">
                    <p class="exchange-text-mid">Stake </p>
                    <input tabindex="6" class="value-box-laystake" [readOnly]="true" placeholder="{{sab.layStake | number:'0.2-2' }}">
                  </div>
                  <div class="exchange-row">
                    <p class="exchange-text-mid">Odds </p>
                    <input tabindex="0" formControlName="LayOdds" type="number"step="0.1" class = "value-box-lay"  placeholder="{{sab.layOdd| number:'0.2-2'}}">
                  </div>
                </div>

                <div class="exchange-container">
                  <div class="exchange-row" tabindex="1">
                    <button  mat-raised-button class="bet-state-button"  [style.background]="sab.betState ? ' #076044' : '#8a0606'" (click)="sab.betState = !sab.betState">{{ sab.betState ? 'Matched' : 'Unmatched'}}</button>
                  </div>
                  <div class="exchange-row">
                    <p class="liability-text">Liability:</p>
                    <p class="liability-amount">{{ Liability(getGroup(i).get('LayOdds').value, LayStake(getGroup(i).get('BackOdds').value, getGroup(i).get('LayOdds').value, getGroup(i).get('Stake').value)) | currency:'GBP'}} </p>
                  </div>
                </div>
              </div>
            </div>
            <div class="calculated shadow">
              <div class="calculatedcontainer">
              <!-- Comment Box -->
              <div class="calculated-container-comments">
                <div class="comments-cont">
                  <mat-form-field tabindex="1" class="user-comments" appearance="outline">
                    <mat-label class="auto-calc-label">Match Comments</mat-label>
                    <textarea class="auto-calc-input" formControlName="MatchInfo" matInput placeholder="{{sab.comment}}"></textarea>
                    <mat-hint> ({{selectionValues.value.MatchInfo == null ? selectionValues.value.MatchInfo == ' ' : selectionValues.value.MatchInfo.length}}/140)</mat-hint>
                    <mat-error *ngIf="selectionValues.controls.MatchInfo.errors">{{getErrorMessage()}} </mat-error>
                  </mat-form-field>
                </div>
              </div>
              <!-- Calculated Values -->
              <div class="calculated-container">
                <div class="calculated-row">
                  <div class="roi-text">ROI:</div>
                  <span class="calculated-value calculated-value-lhs" *ngIf="sab.isBrkzFTA == 1">{{ ROI(getGroup(i).get('Stake').value, getGroup(i).get('BackOdds').value, getGroup(i).get('LayOdds').value, sab.occ) | number:'0.2-2'}}%</span>
                  <span class="calculated-value calculated-value-lhs" *ngIf="sab.isBrkzFTA == 0 || undefined">{{ ROI(getGroup(i).get('Stake').value, getGroup(i).get('BackOdds').value, getGroup(i).get('LayOdds').value, 65) | number:'0.2-2'}}%</span>
                </div>
                <hr class="value-divider">
                <div class="calculated-row">
                  <div class="ev-text">EV: </div>
                  <span class="calculated-value calculated-value-lhs" *ngIf="sab.isBrkzFTA == 1">{{ TotalEV( sab.occ,  getGroup(i).get('Stake').value, getGroup(i).get('BackOdds').value, getGroup(i).get('LayOdds').value)/sab.occ  | currency:'GBP' }}</span>
                  <span class="calculated-value calculated-value-lhs" *ngIf="sab.isBrkzFTA == 0 || undefined">{{ TotalEV( 65,  getGroup(i).get('Stake').value, getGroup(i).get('BackOdds').value, getGroup(i).get('LayOdds').value)/65  | currency:'GBP' }}</span>
                </div>
                <hr class="value-divider">
                <div class="calculated-row">
                  <div class="mr-text">MR: </div>
                  <span class="calculated-value calculated-value-lhs calculated-value-lhs">{{ NewMatchRating( getGroup(i).get('BackOdds').value, getGroup(i).get('LayOdds').value)  | number:'0.2-2' }}%</span>
                </div>
                <hr class="value-divider">
                <div class="calculated-row">
                  <div class="qlpercent-text">QL%: </div>
                  <span class="calculated-value calculated-value-lhs">{{ NewSS(  getGroup(i).get('BackOdds').value, getGroup(i).get('LayOdds').value, getGroup(i).get('Stake').value ) | number:'0.2-2' }}%</span>
                </div>
              </div>

              <!-- QL and record Bet -->
              <div class="calculated-container">
                <div class="calculated-row">
                  <div class="fta-text">FTA: </div>
                    <span class="fta-value"> {{ FTA(getGroup(i).get('Stake').value, getGroup(i).get('BackOdds').value, getGroup(i).get('LayOdds').value  ) | currency:'GBP'}}</span>
                </div>
                <hr class="value-divider">
                <div class="calculated-row">
                  <div class="ql-text">QL: </div>
                  <span class="ql-value"> {{ QL( getGroup(i).get('BackOdds').value, getGroup(i).get('LayOdds').value, getGroup(i).get('Stake').value) | currency:'GBP'}}  </span>
                </div>
                <div class="calculated-row">
                  <button tabindex="0" mat-raised-button class="exp-button" [disabled]="sab['isSettled']"  (click)="updateSAB(sab, i); expandedElement=null">Update Bet</button>
                </div>
              </div>
            </div>
            </div>
          </div>
        </div>
        </form>
      </ng-container>
     </div>
    </td>
  </ng-container>

  <tr mat-header-row *matHeaderRowDef="columnsToDisplay"></tr>
  <tr mat-row *matRowDef="let sab; columns: columnsToDisplay;"
      class="sab-row"
      [appSettledBet] [isSettled]="sab.isSettled"
      [class.sab-expanded-row]="expandedElement === sab"
      (click)="expandedElement = expandedElement === sab ? null : sab;">
  </tr>
  <tr mat-row *matRowDef="let row; columns: ['expandedDetail']" class="sab-detail-row"></tr>
</table>
<div class="no-content" *ngIf="isEmptySABList">All bets settled!</div>
